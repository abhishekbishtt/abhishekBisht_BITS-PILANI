# Use Python 3.9 as the base image
FROM python:3.9

# 1. Install system dependencies (Poppler is required for pdf2image)
RUN apt-get update && apt-get install -y \
    poppler-utils \
    && rm -rf /var/lib/apt/lists/*

# Set up a new user named "user" (Recommended for security on HF)
RUN useradd -m -u 1000 user
USER user
ENV HOME=/home/user \
	PATH=/home/user/.local/bin:$PATH

WORKDIR $HOME/app

# 2. Copy requirements and install Python dependencies
COPY --chown=user ./requirements.txt requirements.txt
RUN pip install --no-cache-dir --upgrade -r requirements.txt

# 3. Copy your main.py and other files
COPY --chown=user . $HOME/app

# 4. Start FastAPI on port 7860 (Hugging Face specific port)
# Note: We point to 'main:app' because your file is named main.py
CMD ["uvicorn", "main:app.main", "--host", "0.0.0.0", "--port", "7860"]